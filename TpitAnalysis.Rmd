---
title: "TpitReport"
author: "W. McDonald"
date: "2/24/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Goal

The goal of this document is to reproducibly import, wrangle and analyse the full pituitary adenoma tissue microarray dataset, including all immunostains up to *Tpit*. *CAM5.2* staining pattern is included, as a relevant categorical variable. Otherwise, IHC staining extant and intensity are reported as Allred scores as previously published. 

This analysis will rely on the tools of the tidyverse, when possible. 

## Data import, wrangling.

```{r echo=TRUE}
library(tidyverse)

patma <- read_csv("data/TpitAddedDx")

patma %>%
  count(newDx, sort = TRUE)

tsh <- patma %>%
  group_by(newDx) %>%
  summarize(mean(TSHMedian, na.rm = TRUE)) 

tsh

```

## IHC by diagnosis scatter plots

A basic understanding of the staining patterns is an important first step. 

Multiple ways to display these in a grid. The gridExtra package is pretty simple. See [this useful vignette](https://cran.r-project.org/web/packages/egg/vignettes/Ecosystem.html).

```{r}
library(gridExtra)
p<-ggplot(patma, aes(newDx, TPITMedian))
p1 <- p + geom_point(position=position_jitter(width=0.3, height=0.1)) +
  theme_minimal() +
  coord_flip() +
  labs(x="Diagnostic Class") +
  labs(y="Allred Score") +
  labs(title="Tpit Median IHC Score")

p<-ggplot(patma, aes(newDx, SF1Median))
p2 <- p + geom_point(position=position_jitter(width=0.3, height=0.1)) +
  theme_minimal() +
  coord_flip() +
  labs(x="Diagnostic Class") +
  labs(y="Allred Score") +
  labs(title="SF-1 Median IHC Score")

p<-ggplot(patma, aes(newDx, Pit1Median))
p3 <- p + geom_point(position=position_jitter(width=0.3, height=0.1)) +
  theme_minimal() +
  coord_flip() +
  labs(x="Diagnostic Class") +
  labs(y="Allred Score") +
  labs(title="Pit-1 Median IHC Score")

grid.arrange(p1, p2, p3, nrow = 1)

```


## Correlation matrix and p values for the correlations

Beyond the R help documentation for cor(), I like the visualizations from [this site that uses corrplot](http://www.sthda.com/english/wiki/visualize-correlation-matrix-using-correlogram)

The package Hmisc is used to generate p-values for the correlation matrix.

```{r}
library(corrplot)
patma %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian) %>% 
  cor(y = NULL, use = "complete.obs", method = "pearson") %>% 
  round(2)

M <- patma %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian, ASUMedian, GATA3Median) %>% 
  cor(y = NULL, use = "complete.obs", method = "pearson")

corrplot(M, type = "upper", order = "hclust")

library(Hmisc)

pvalues <- patma %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian, ASUMedian, GATA3Median) %>% 
  cor(y = NULL, use = "complete.obs", method = "pearson") %>%
  as.matrix() %>%
  rcorr()

pvalues

```

## Hierarchical clustering

Note that the hierarchical clustering profits from name transparency when producing the final plot. The first bits of code make an object that has lost newDx and CaseID in favor of a row name that bears a combination of the two. 

```{r}
rowsAssigned <- patma %>%
  unite("RowNames", c("CaseID", "newDx")) %>%
  column_to_rownames(var = "RowNames")

df <- rowsAssigned %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian, ASUMedian, GATA3Median) %>%
  na.omit()

d <- dist(df, method = "euclidean")

hc1 <- hclust(d, method = "complete")

plot(hc1, cex = 0.6, hang = -1)


```

## K-means cluster analysis and display using clusplot()

Two things are recommended when performing K-means clustering: assign a large nstart and using the setseed() function

```{r}
set.seed(2019)
rowsAssigned <- patma %>%
  unite("RowNames", c("CaseID", "newDx")) %>%
  column_to_rownames(var = "RowNames")

km6 <- rowsAssigned %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian) %>%
  na.omit() %>% 
  kmeans(6,nstart=20)

km6
km.g6 <- km6$cluster
km.g6 %>% sort()

```

## Principle component analysis (PCA)

Work in progress: check out [this site for some good techniques](http://huboqiang.cn/2016/03/03/RscatterPlotPCA).

See also [this page](https://community.rstudio.com/t/tidyverse-solutions-for-factor-analysis-principal-component-analysis/4504).

PCA using tidyverse tools requires a little different method. See [this work](https://tbradley1013.github.io/2018/02/01/pca-in-a-tidy-verse-framework/) by Tyler Bradley. 

```{r}
pc <- patma %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian) %>%
  na.omit() %>% 
  prcomp(center = TRUE, scale = TRUE)

summary(pc) # these list the principle components in decending explanatory ability. See proporation of overall variance.
plot(pc) # how many components do you want to include? No set answer
pc # rotation section lets us know the relationship between IHC and principle components
predict(pc)
biplot(pc) # VERY interesting in its ability to distinguish between the Pit1, SF1 and Tpit groups

library(ggfortify)
df <- patma %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian) %>%
  na.omit()

trimmedSet <- patma %>% 
  select(SF1Median, Pit1Median, TPITMedian, PRLMedian, GHMedian, TSHMedian, LHMedian, FSHMedian, ACTHMedian, newDx) %>%
  na.omit()

autoplot(prcomp(df), data = trimmedSet, colour = 'newDx', size = 8)

```

## T-SNE (t-Distributed Stochastic Neighbor Embedding) analysis

This is an interesting method that is usually compared with PCA plots. See [this page](https://stackoverflow.com/questions/44837536/how-to-use-ggplot-to-plot-t-sne-clustering).

```{r}
library(Rtsne)
patma_unique <- patma %>% 
  na.omit() %>% 
  unique()
patma_matrix <- as.matrix(patma_unique[,c(4:12, 18, 23, 24)])
set.seed(2019)
tsne_out <- Rtsne(patma_matrix, check_duplicates = FALSE, theta = 0.0) 

library(ggplot2)
tsne_plot <- data.frame(x = tsne_out$Y[,1], y = tsne_out$Y[,2], Diagnoses = patma_unique$newDx)

ggplot(tsne_plot) + 
  geom_point(aes(x=x, y=y, color=Diagnoses), size = 5) +
  theme_minimal()
```

## Factor analysis


```{r}

```

## Classification trees

This [webpage](http://www.sthda.com/english/articles/35-statistical-machine-learning-essentials/141-cart-model-decision-tree-essentials/) has a nice discussion of CART analyses in tidyverse terms. 

```{r}

```


